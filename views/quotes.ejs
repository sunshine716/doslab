<% function toUSD(val) { return Number(val).toLocaleString('en-US', {
minimumFractionDigits: 2, maximumFractionDigits: 2 }); } %>

<!-- Main Content -->
<div class="content flex-grow-1 p-4">
  <h2>Approved Quotes</h2>
  <p>Coupon codes may be available for these quotesâ€”please contact our sales team for more information.
  <p>You are now ready to finalize your quotes so the manufacturer can begin production.</p>

  <!-- Search Bar -->
  <form class="mb-3" method="GET" action="/quotes">
    <div class="input-group w-50">
      <input
        type="text"
        class="form-control"
        placeholder="Search by name or email..."
        name="query"
      />
      <button class="btn btn-primary" type="submit">Search</button>
    </div>
  </form>

  <div class="table-responsive">
    <table class="table table-bordered table-striped">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>IPN/CPN</th>
          <th>Part Name</th>
          <th>Manufacturer</th>
          <th>Unit Price</th>
          <th>Qty</th>
          <th>Line Total (USD)</th>
        </tr>
      </thead>
      <tbody>
        <% data.forEach(function(quote, idx) { %>
        <tr>
          <td><%= (currentPage - 1) * limit + idx + 1 %></td>
          <td><%= quote.ipn_or_cpn %></td>
          <td><%= quote.part_name %></td>
          <td><%= quote.manufacturer %></td>
          <td><%= quote.unit_price%></td>
          <td><%= quote.qty %></td>
          <td><%= toUSD(quote.line_total) %></td>
        </tr>
        <% }); %>
        <!-- Add more rows here -->
      </tbody>
      <!-- Pagination UI (static example) -->
    </table>
    <nav aria-label="Quotes Table Pagination">
      <ul class="pagination">
        <% if (currentPage > 1) { %>
        <li class="page-item">
          <a class="page-link" href="?page=<%= currentPage - 1 %>"
            >&laquo; Previous</a
          >
        </li>
        <% } else { %>
        <li class="page-item disabled">
          <span class="page-link">&laquo; Previous</span>
        </li>
        <% } %> <% for (var i = 1; i <= totalPages; i++) { %>
        <li class="page-item <%= i === currentPage ? 'active' : '' %>">
          <a class="page-link" href="?page=<%= i %>"><%= i %></a>
        </li>
        <% } %> <% if (currentPage < totalPages) { %>
        <li class="page-item">
          <a class="page-link" href="?page=<%= currentPage + 1 %>"
            >Next &raquo;</a
          >
        </li>
        <% } else { %>
        <li class="page-item disabled">
          <span class="page-link">Next &raquo;</span>
        </li>
        <% } %>
      </ul>
    </nav>
  </div>

  <!-- Coupon Summary Card -->
  <div class="card mb-4 shadow-sm" style="max-width: 600px">
    <div class="card-body">
      <h5 class="card-title mb-3">Order Summary</h5>

      <!-- Order Info -->
      <div class="row">
        <div class="col-6 mb-2"><strong>Items:</strong> <%= data.reduce((sum, quote) => sum + parseInt(quote.qty), 0) %></div>
        <div class="col-6 mb-2"><strong>Subtotal:</strong> $<%= toUSD(data.reduce((sum, quote) => sum + parseFloat(quote.line_total), 0)) %></div>
        <div class="col-6 mb-2">
          <strong>Discount:</strong>
          <span class="text-danger"><%= toUSD(0) %></span>
        </div>
        <div class="col-6 mb-2">
          <strong>Total:</strong>
          <span class="text-success fw-bold"><%= toUSD(data.reduce((sum, quote) => sum + parseFloat(quote.line_total), 0)) %></span>
        </div>
      </div>

      <!-- Coupon Form -->
      <form class="mt-3" method="POST" action="/coupon">
        <div class="input-group">
          <input
            type="text"
            name="couponCode"
            class="form-control"
            placeholder="Enter coupon code..."
            required
          />
          <button class="btn btn-outline-primary" type="submit">Apply</button>
        </div>
      </form>

      <div class="mt-2 text-info"></div>
    </div>
  </div>
</div>

<script>
document.querySelector('form[action="/coupon"]').addEventListener('submit', async function(e) {
  e.preventDefault();
  const form = e.target;
  const couponCode = form.couponCode.value;

  const res = await fetch('/coupon', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ couponCode })
  });

  const data = await res.json();
  // Update the UI based on response
  if (data.success) {
    document.querySelector('.mt-2.text-info').textContent = 'Coupon applied successfully!';
    // Optionally update discount/total here
  } else {
    document.querySelector('.mt-2.text-info').textContent = data.message || 'Invalid coupon!';
  }
});
</script>